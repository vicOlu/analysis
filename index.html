<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Flow Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #111820;
            --bg-card: #151c26;
            --bg-card-hover: #1a2332;
            --border-color: #2a3544;
            --border-highlight: #3d4f65;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-bullish: #3fb950;
            --accent-bullish-dim: #238636;
            --accent-bearish: #f85149;
            --accent-bearish-dim: #da3633;
            --accent-warning: #d29922;
            --accent-info: #58a6ff;
            --accent-purple: #a371f7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .noise-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            z-index: 1000;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-mark {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--accent-info), var(--accent-purple));
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(88, 166, 255, 0.25);
        }

        .logo-mark svg { width: 28px; height: 28px; stroke: white; fill: none; }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 0.35rem;
        }

        .subtitle { color: var(--text-secondary); font-size: 0.95rem; }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(17, 24, 32, 0.5), rgba(21, 28, 38, 0.5));
            position: relative;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--accent-info);
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05), rgba(163, 113, 247, 0.05));
        }

        .upload-zone svg { width: 48px; height: 48px; stroke: var(--text-muted); margin-bottom: 1rem; }
        .upload-zone h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .upload-zone p { color: var(--text-muted); font-size: 0.9rem; }
        .upload-zone input { display: none; }

        .file-info {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .file-info.visible { display: inline-flex; }
        .file-info .file-name { color: var(--accent-info); }
        .file-info .file-size { color: var(--text-muted); }

        .export-buttons { display: flex; justify-content: center; margin-bottom: 2rem; gap: 1rem; }

        .export-btn {
            display: none;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--accent-info), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3); }
        .export-btn.visible { display: inline-flex; align-items: center; gap: 0.5rem; }
        .export-btn svg { width: 16px; height: 16px; }

        /* Filters */
        .filters {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filters.visible {
            display: flex;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 180px;
        }

        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .filter-select:hover {
            border-color: var(--border-highlight);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-info);
        }

        .filter-reset {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-reset:hover {
            border-color: var(--accent-bearish);
            color: var(--accent-bearish);
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .filter-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-info);
            cursor: pointer;
        }

        .filter-toggle label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        .filter-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 0.5rem 0;
        }

        .filter-count span {
            color: var(--accent-info);
        }

        .analysis-output { display: none; }
        .analysis-output.visible { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover { border-color: var(--border-highlight); transform: translateY(-2px); }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-value.bullish { color: var(--accent-bullish); }
        .stat-value.bearish { color: var(--accent-bearish); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }

        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .section.collapsed .section-header {
            border-bottom: none;
        }

        .section-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .section-header:hover {
            background: var(--bg-card-hover);
        }

        .section-chevron {
            width: 16px;
            height: 16px;
            stroke: var(--text-muted);
            transition: transform 0.2s ease;
            margin-left: auto;
        }

        .section.collapsed .section-chevron {
            transform: rotate(-90deg);
        }

        .section-icon {
            width: 36px; height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .section-icon.bullish { background: rgba(63, 185, 80, 0.15); color: var(--accent-bullish); }
        .section-icon.bearish { background: rgba(248, 81, 73, 0.15); color: var(--accent-bearish); }
        .section-icon.neutral { background: rgba(88, 166, 255, 0.15); color: var(--accent-info); }
        .section-icon svg { width: 18px; height: 18px; }
        .section-title { flex: 1; font-weight: 600; font-size: 1rem; }

        .section-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .section-content { padding: 1.25rem; }

        .flow-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .flow-card:last-child { margin-bottom: 0; }

        .flow-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .flow-ticker { display: flex; align-items: center; gap: 0.75rem; }

        .ticker-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .direction-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .direction-badge.bullish { background: rgba(63, 185, 80, 0.15); color: var(--accent-bullish); }
        .direction-badge.bearish { background: rgba(248, 81, 73, 0.15); color: var(--accent-bearish); }

        .flow-premium { text-align: right; }

        .premium-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-info);
        }

        .premium-label { font-size: 0.75rem; color: var(--text-muted); }

        .flow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-item {
            background: var(--bg-card);
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.2rem;
        }

        .detail-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .flow-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .check-item {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .check-item.pass { background: rgba(63, 185, 80, 0.1); color: var(--accent-bullish); }
        .check-item.fail { background: rgba(248, 81, 73, 0.1); color: var(--accent-bearish); }
        .check-item.neutral { background: rgba(210, 153, 34, 0.1); color: var(--accent-warning); }

        .conviction-score {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .conviction-score.high { background: rgba(63, 185, 80, 0.15); color: var(--accent-bullish); }
        .conviction-score.medium { background: rgba(210, 153, 34, 0.15); color: var(--accent-warning); }
        .conviction-score.low { background: rgba(248, 81, 73, 0.15); color: var(--accent-bearish); }

        .flow-analysis { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }

        .cluster-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .cluster-header:hover { background: var(--bg-card-hover); }

        .cluster-trades-wrapper { overflow-x: auto; }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .summary-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-table tr:last-child td { border-bottom: none; }
        .summary-table .ticker { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .summary-table .premium { font-family: 'JetBrains Mono', monospace; color: var(--accent-info); }

        .loading { display: none; text-align: center; padding: 3rem; }
        .loading.visible { display: block; }

        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: var(--text-muted); font-size: 0.95rem; }

        @media (max-width: 640px) {
            .container { padding: 1.5rem 1rem 3rem; }
            h1 { font-size: 1.4rem; }
            .upload-zone { padding: 2rem 1rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .flow-card-header { flex-direction: column; gap: 0.75rem; }
            .flow-premium { text-align: left; }
            .flow-details { grid-template-columns: 1fr 1fr; }
        }

        .upload-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .upload-zone.secondary {
            padding: 1.5rem 1rem;
        }

        .upload-zone.secondary svg {
            width: 32px;
            height: 32px;
            margin-bottom: 0.5rem;
        }

        .upload-zone.secondary h3 {
            font-size: 0.95rem;
        }

        .upload-zone.secondary p {
            font-size: 0.8rem;
        }

        .upload-zone.loaded {
            border-color: var(--accent-bullish);
            border-style: solid;
        }

        .earnings-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            background: rgba(210, 153, 34, 0.15);
            color: var(--accent-warning);
        }

        .signal-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }

        .signal-badge.insider {
            background: rgba(163, 113, 247, 0.15);
            color: var(--accent-purple);
        }

        @media (max-width: 640px) {
            .upload-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    <div class="container">
        <header>
            <div class="logo-mark">
                <svg viewBox="0 0 24 24" stroke-width="2">
                    <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h1>Options Flow Analyzer</h1>
            <p class="subtitle">Upload your options flow CSV to identify high-conviction flows</p>
        </header>

        <div class="upload-row">
            <div class="upload-zone" id="upload-zone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>Options Flow CSV</h3>
                <p>Drop or click to upload</p>
                <input type="file" id="file-input" accept=".csv">
                <div class="file-info" id="file-info">
                    <span class="file-name" id="file-name"></span>
                    <span class="file-size" id="file-size"></span>
                </div>
            </div>
            <div class="upload-zone secondary" id="alert-upload-zone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>AlertStream CSV (Optional)</h3>
                <p>Dark pool, insider, earnings data</p>
                <input type="file" id="alert-file-input" accept=".csv">
                <div class="file-info" id="alert-file-info">
                    <span class="file-name" id="alert-file-name"></span>
                    <span class="file-size" id="alert-file-size"></span>
                </div>
            </div>
        </div>

        <div class="export-buttons">
            <button class="export-btn" id="fetch-prices-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span id="fetch-prices-text">Fetch Live Prices</span>
            </button>
            <button class="export-btn" id="export-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Save Report
            </button>
        </div>

        <div class="filters" id="filters">
            <div class="filter-group">
                <label class="filter-label">Ticker</label>
                <select class="filter-select" id="filter-ticker">
                    <option value="">All Tickers</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Security</label>
                <select class="filter-select" id="filter-security">
                    <option value="">All</option>
                    <option value="STOCK">Stocks Only</option>
                    <option value="ETF">ETFs Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Expiration</label>
                <select class="filter-select" id="filter-dte">
                    <option value="">All DTE</option>
                    <option value="30">â‰¤ 30 days</option>
                    <option value="60">31-60 days</option>
                    <option value="90">61-90 days</option>
                    <option value="90+">90+ days</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Type</label>
                <select class="filter-select" id="filter-type">
                    <option value="">All Types</option>
                    <option value="SWEEP">Sweeps Only</option>
                    <option value="BLOCK">Blocks Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Direction</label>
                <select class="filter-select" id="filter-direction">
                    <option value="">All</option>
                    <option value="CALL">Calls Only</option>
                    <option value="PUT">Puts Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Min Premium</label>
                <select class="filter-select" id="filter-premium">
                    <option value="">All</option>
                    <option value="50000">$50K+</option>
                    <option value="100000">$100K+</option>
                    <option value="200000">$200K+</option>
                    <option value="500000">$500K+</option>
                </select>
            </div>
            <div class="filter-toggle">
                <input type="checkbox" id="filter-exclude-itm">
                <label for="filter-exclude-itm">Exclude ITM</label>
            </div>
            <div class="filter-toggle">
                <input type="checkbox" id="filter-unique-tickers">
                <label for="filter-unique-tickers" style="color:var(--accent-info)">Unique Tickers Only</label>
            </div>
            <div class="filter-toggle">
                <input type="checkbox" id="filter-require-blocks">
                <label for="filter-require-blocks" style="color:var(--accent-warning)">Require AA/BB Blocks</label>
            </div>
            <div class="filter-toggle">
                <input type="checkbox" id="filter-high-conviction">
                <label for="filter-high-conviction" style="color:var(--accent-bullish);font-weight:600">ðŸŽ¯ High Conviction Only</label>
            </div>
            <button class="filter-reset" id="filter-reset">Reset Filters</button>
            <div class="filter-count" id="filter-count"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing flow data...</p>
        </div>

        <div class="analysis-output" id="analysis-output">
            <div class="stats-grid" id="stats-grid"></div>

            <div class="section" id="correlated-signals-section" style="display:none">
                <div class="section-header" onclick="toggleSection('correlated-signals-section')">
                    <div class="section-icon" style="background: rgba(163, 113, 247, 0.15); color: var(--accent-purple);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Correlated Signals</span>
                    <span class="section-badge" id="correlated-signals-count">0</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="correlated-signals"></div>
            </div>

            <div class="section" id="high-conviction-section">
                <div class="section-header" onclick="toggleSection('high-conviction-section')">
                    <div class="section-icon bullish">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">High Conviction Flows</span>
                    <span class="section-badge" id="high-conviction-count">0</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="high-conviction-flows"></div>
            </div>

            <div class="section" id="clustering-section">
                <div class="section-header" onclick="toggleSection('clustering-section')">
                    <div class="section-icon neutral">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Trade Clustering</span>
                    <span class="section-badge" id="clustering-count">0</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="clustering-analysis"></div>
            </div>

            <div class="section" id="large-trades-section">
                <div class="section-header" onclick="toggleSection('large-trades-section')">
                    <div class="section-icon neutral">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Largest Individual Trades</span>
                    <span class="section-badge" id="large-trades-count">0</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="large-trades"></div>
            </div>

            <div class="section" id="flow-characteristics-section">
                <div class="section-header" onclick="toggleSection('flow-characteristics-section')">
                    <div class="section-icon neutral">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Flow Characteristics</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="flow-characteristics"></div>
            </div>

            <div class="section" id="summary-section">
                <div class="section-header" onclick="toggleSection('summary-section')">
                    <div class="section-icon neutral">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Top Tickers by Premium</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="summary-table"></div>
            </div>

            <div class="section" id="expiration-heatmap-section">
                <div class="section-header" onclick="toggleSection('expiration-heatmap-section')">
                    <div class="section-icon neutral">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Expiration Heat Map</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="expiration-heatmap"></div>
            </div>

            <div class="section" id="golden-sweeps-section">
                <div class="section-header" onclick="toggleSection('golden-sweeps-section')">
                    <div class="section-icon" style="background: rgba(210, 153, 34, 0.15); color: var(--accent-warning);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Golden Sweeps</span>
                    <span class="section-badge" id="golden-sweeps-count">0</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="golden-sweeps"></div>
            </div>

            <div class="section" id="unusual-section">
                <div class="section-header" onclick="toggleSection('unusual-section')">
                    <div class="section-icon" style="background: rgba(163, 113, 247, 0.15); color: var(--accent-purple);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="section-title">Unusual Options Activity</span>
                    <span class="section-badge" id="unusual-count">0</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div class="section-content" id="unusual-activity"></div>
            </div>
        </div>
    </div>

    <script>
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        function toggleCluster(idx) {
            const el = document.getElementById(`cluster-${idx}`);
            const chevron = document.getElementById(`chevron-${idx}`);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
            } else {
                el.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        const fmt = (n) => n >= 1e6 ? '$' + (n/1e6).toFixed(2) + 'M' : n >= 1e3 ? '$' + (n/1e3).toFixed(0) + 'K' : '$' + n.toFixed(0);
        const num = (n) => n.toLocaleString();

        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const exportBtn = document.getElementById('export-btn');
        const fetchPricesBtn = document.getElementById('fetch-prices-btn');
        const fetchPricesText = document.getElementById('fetch-prices-text');
        const loading = document.getElementById('loading');
        const output = document.getElementById('analysis-output');
        const filtersEl = document.getElementById('filters');
        const filterTicker = document.getElementById('filter-ticker');
        const filterSecurity = document.getElementById('filter-security');
        const filterDte = document.getElementById('filter-dte');
        const filterType = document.getElementById('filter-type');
        const filterDirection = document.getElementById('filter-direction');
        const filterPremium = document.getElementById('filter-premium');
        const filterExcludeItm = document.getElementById('filter-exclude-itm');
        const filterUniqueTickers = document.getElementById('filter-unique-tickers');
        const filterRequireBlocks = document.getElementById('filter-require-blocks');
        const filterHighConviction = document.getElementById('filter-high-conviction');
        const filterReset = document.getElementById('filter-reset');
        const filterCount = document.getElementById('filter-count');
        
        // AlertStream elements
        const alertUploadZone = document.getElementById('alert-upload-zone');
        const alertFileInput = document.getElementById('alert-file-input');
        const alertFileInfo = document.getElementById('alert-file-info');
        const alertFileName = document.getElementById('alert-file-name');
        const alertFileSize = document.getElementById('alert-file-size');
        
        let currentFileName = '';
        let allFlows = []; // Store all flows for filtering
        let alertStreamData = { darkPool: {}, blocks: {}, insider: {}, earnings: {}, sector: {}, weekHigh: {}, weekLow: {}, orb: {}, priceSpike: {}, halted: {}, volumeAlert: {} }; // Store AlertStream data by ticker
        let livePrices = {}; // Store live prices by ticker
        const FINNHUB_API_KEY = 'd53d9khr01qkplgudi8gd53d9khr01qkplgudi90';

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files[0]?.name.endsWith('.csv')) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) processFile(e.target.files[0]); });

        // AlertStream upload handlers
        alertUploadZone.addEventListener('click', () => alertFileInput.click());
        alertUploadZone.addEventListener('dragover', (e) => { e.preventDefault(); alertUploadZone.classList.add('drag-over'); });
        alertUploadZone.addEventListener('dragleave', () => alertUploadZone.classList.remove('drag-over'));
        alertUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            alertUploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files[0]?.name.endsWith('.csv')) processAlertFile(e.dataTransfer.files[0]);
        });
        alertFileInput.addEventListener('change', (e) => { if (e.target.files[0]) processAlertFile(e.target.files[0]); });

        function processAlertFile(file) {
            alertFileName.textContent = file.name;
            alertFileSize.textContent = (file.size / 1024).toFixed(1) + ' KB';
            alertFileInfo.classList.add('visible');
            alertUploadZone.classList.add('loaded');
            
            Papa.parse(file, {
                header: true,
                complete: (r) => {
                    alertStreamData = { 
                        darkPool: {}, 
                        blocks: {},
                        insider: {}, 
                        earnings: {}, 
                        sector: {},
                        weekHigh: {},
                        weekLow: {},
                        orb: {},
                        priceSpike: {},
                        halted: {},
                        volumeAlert: {}
                    };
                    
                    r.data.forEach(row => {
                        if (!row.Ticker) return;
                        const ticker = row.Ticker.toUpperCase();
                        
                        // Store earnings date
                        if (row.EarningsDate && row.EarningsDate.length === 8) {
                            const ed = row.EarningsDate;
                            const formatted = `${ed.slice(0,4)}-${ed.slice(4,6)}-${ed.slice(6,8)}`;
                            alertStreamData.earnings[ticker] = formatted;
                        }
                        
                        // Store sector/industry
                        if (row.Sector || row.Industry) {
                            alertStreamData.sector[ticker] = { sector: row.Sector, industry: row.Industry };
                        }
                        
                        // Track dark pool activity
                        if (row.Type === 'DarkPool') {
                            if (!alertStreamData.darkPool[ticker]) alertStreamData.darkPool[ticker] = [];
                            alertStreamData.darkPool[ticker].push({
                                time: row.Timestamp,
                                price: parseFloat(row.Price) || 0,
                                message: row.Message
                            });
                        }
                        
                        // Track block trades with direction
                        if (row.Type === 'Block' && row.Message) {
                            const msg = row.Message;
                            // Skip phantom prints
                            if (msg.includes('Phantom')) return;
                            
                            if (!alertStreamData.blocks[ticker]) alertStreamData.blocks[ticker] = [];
                            
                            // Determine direction from message
                            let direction = 'neutral';
                            if (msg.includes(' AA ')) direction = 'bullish';
                            else if (msg.includes(' BB ')) direction = 'bearish';
                            
                            // Determine type
                            let blockType = 'BLOCK';
                            if (msg.includes('DARK ISO')) blockType = 'DARK ISO';
                            else if (msg.includes('DARK BLOCK')) blockType = 'DARK BLOCK';
                            else if (msg.includes('DARK AVGPRC')) blockType = 'DARK AVGPRC';
                            
                            alertStreamData.blocks[ticker].push({
                                time: row.Timestamp,
                                price: parseFloat(row.Price) || 0,
                                volume: parseInt(row.Volume) || 0,
                                notional: parseFloat(row.Notional) || 0,
                                direction,
                                blockType,
                                message: msg
                            });
                        }
                        
                        // Track ORB (Opening Range Breakout)
                        if (row.Type === 'Orb' && row.Message) {
                            const msg = row.Message;
                            const direction = msg.includes('Upside') ? 'bullish' : msg.includes('Downside') ? 'bearish' : 'neutral';
                            alertStreamData.orb[ticker] = {
                                time: row.Timestamp,
                                price: parseFloat(row.Price) || 0,
                                direction,
                                message: msg
                            };
                        }
                        
                        // Track Price Spikes
                        if (row.Type === 'PriceSpike' && row.Message) {
                            const msg = row.Message;
                            // Extract percentage from "Price Spike Alert 18.77%"
                            const pctMatch = msg.match(/(\d+\.?\d*)%/);
                            const pct = pctMatch ? parseFloat(pctMatch[1]) : 0;
                            if (pct > 0) {
                                alertStreamData.priceSpike[ticker] = {
                                    time: row.Timestamp,
                                    price: parseFloat(row.Price) || 0,
                                    percent: pct,
                                    message: msg
                                };
                            }
                        }
                        
                        // Track Halts
                        if (row.Type === 'Halted' && row.Message) {
                            const isHalted = row.Message.includes('Stock is Halted');
                            if (isHalted) {
                                alertStreamData.halted[ticker] = {
                                    time: row.Timestamp,
                                    message: row.Message
                                };
                            } else {
                                // Remove from halted if no longer halted
                                delete alertStreamData.halted[ticker];
                            }
                        }
                        
                        // Track unusual volume from General alerts
                        if (row.Type === 'General' && row.Message) {
                            const msg = row.Message;
                            if (msg.includes('Volume Above Average') || msg.includes('Volume Active')) {
                                alertStreamData.volumeAlert[ticker] = {
                                    time: row.Timestamp,
                                    price: parseFloat(row.Price) || 0,
                                    message: msg
                                };
                            }
                        }
                        
                        // Track 52-week highs
                        if (row.Type === 'AnnualHigh') {
                            alertStreamData.weekHigh[ticker] = {
                                time: row.Timestamp,
                                price: parseFloat(row.Price) || 0
                            };
                        }
                        
                        // Track 52-week lows
                        if (row.Type === 'AnnualLow') {
                            alertStreamData.weekLow[ticker] = {
                                time: row.Timestamp,
                                price: parseFloat(row.Price) || 0
                            };
                        }
                        
                        // Track insider buys
                        if (row.Message && row.Message.includes('Insider Buy')) {
                            if (!alertStreamData.insider[ticker]) alertStreamData.insider[ticker] = [];
                            alertStreamData.insider[ticker].push({
                                time: row.Timestamp,
                                message: row.Message
                            });
                        }
                    });
                    
                    // Re-analyze if we already have flow data
                    if (allFlows.length > 0) {
                        applyFilters();
                    }
                }
            });
        }

        // Filter event listeners
        filterTicker.addEventListener('change', applyFilters);
        filterSecurity.addEventListener('change', applyFilters);
        filterDte.addEventListener('change', applyFilters);
        filterType.addEventListener('change', applyFilters);
        filterDirection.addEventListener('change', applyFilters);
        filterPremium.addEventListener('change', applyFilters);
        filterExcludeItm.addEventListener('change', applyFilters);
        filterUniqueTickers.addEventListener('change', applyFilters);
        filterRequireBlocks.addEventListener('change', applyFilters);
        filterHighConviction.addEventListener('change', applyFilters);
        filterReset.addEventListener('click', resetFilters);

        function resetFilters() {
            filterTicker.value = '';
            filterSecurity.value = '';
            filterDte.value = '';
            filterType.value = '';
            filterDirection.value = '';
            filterPremium.value = '';
            filterExcludeItm.checked = false;
            filterUniqueTickers.checked = false;
            filterRequireBlocks.checked = false;
            filterHighConviction.checked = false;
            applyFilters();
        }

        function applyFilters() {
            let filtered = [...allFlows];
            
            if (filterTicker.value) {
                filtered = filtered.filter(f => f.Symbol === filterTicker.value);
            }
            if (filterSecurity.value) {
                filtered = filtered.filter(f => f.StockEtf === filterSecurity.value);
            }
            if (filterDte.value) {
                if (filterDte.value === '30') {
                    filtered = filtered.filter(f => f.Dte <= 30);
                } else if (filterDte.value === '60') {
                    filtered = filtered.filter(f => f.Dte > 30 && f.Dte <= 60);
                } else if (filterDte.value === '90') {
                    filtered = filtered.filter(f => f.Dte > 60 && f.Dte <= 90);
                } else if (filterDte.value === '90+') {
                    filtered = filtered.filter(f => f.Dte > 90);
                }
            }
            if (filterType.value) {
                filtered = filtered.filter(f => f.Type === filterType.value);
            }
            if (filterDirection.value) {
                filtered = filtered.filter(f => f.CallPut === filterDirection.value);
            }
            if (filterPremium.value) {
                const minPremium = parseInt(filterPremium.value);
                filtered = filtered.filter(f => f.Premium >= minPremium);
            }
            if (filterExcludeItm.checked) {
                filtered = filtered.filter(f => {
                    // For calls: keep only if strike >= spot (ATM/OTM)
                    // For puts: keep only if strike <= spot (ATM/OTM)
                    if (f.CallPut === 'CALL') return f.Strike >= f.Spot;
                    if (f.CallPut === 'PUT') return f.Strike <= f.Spot;
                    return true;
                });
            }
            
            filterCount.innerHTML = `Showing <span>${filtered.length}</span> of <span>${allFlows.length}</span> trades`;
            analyze(filtered, filterHighConviction.checked, filterUniqueTickers.checked, filterRequireBlocks.checked);
        }

        function populateFilters(flows) {
            // Get unique tickers sorted alphabetically
            const tickers = [...new Set(flows.map(f => f.Symbol))].sort();
            filterTicker.innerHTML = '<option value="">All Tickers</option>' + 
                tickers.map(t => `<option value="${t}">${t}</option>`).join('');
            
            filterCount.innerHTML = `Showing <span>${flows.length}</span> of <span>${flows.length}</span> trades`;
        }

        function processFile(file) {
            currentFileName = file.name.replace('.csv', '');
            fileName.textContent = file.name;
            fileSize.textContent = (file.size / 1024).toFixed(1) + ' KB';
            fileInfo.classList.add('visible');
            exportBtn.classList.remove('visible');
            fetchPricesBtn.classList.remove('visible');
            livePrices = {}; // Reset live prices
            fetchPricesText.textContent = 'Fetch Live Prices'; // Reset button text
            filtersEl.classList.remove('visible');
            loading.classList.add('visible');
            output.classList.remove('visible');

            Papa.parse(file, {
                header: true,
                complete: (r) => {
                    setTimeout(() => {
                        // Parse and store all flows
                        allFlows = r.data.filter(row => row.Symbol && row.Premium);
                        allFlows.forEach(row => {
                            row.Volume = parseInt(row.Volume) || 0;
                            row.Price = parseFloat(row.Price) || 0;
                            row.Strike = parseFloat(row.Strike) || 0;
                            row.Spot = parseFloat(row.Spot) || 0;
                            row.Premium = parseInt(row.Premium) || 0;
                            row.Dte = parseInt(row.Dte) || 0;
                        });
                        
                        // Filter out $0 spot tickers (noise/bad data)
                        allFlows = allFlows.filter(row => row.Spot > 0);
                        
                        populateFilters(allFlows);
                        analyze(allFlows);
                        
                        loading.classList.remove('visible');
                        output.classList.add('visible');
                        exportBtn.classList.add('visible');
                        fetchPricesBtn.classList.add('visible');
                        filtersEl.classList.add('visible');
                    }, 400);
                },
                error: () => { loading.classList.remove('visible'); alert('Error parsing CSV'); }
            });
        }

        function analyze(flows, highConvictionOnly = false, uniqueTickersOnly = false, requireBlocks = false) {

            const total = flows.reduce((s, f) => s + f.Premium, 0);
            const calls = flows.filter(f => f.CallPut === 'CALL');
            const puts = flows.filter(f => f.CallPut === 'PUT');
            const bullish = calls.filter(f => ['A','AA'].includes(f.Side)).reduce((s,f) => s + f.Premium, 0)
                + puts.filter(f => ['B','BB'].includes(f.Side)).reduce((s,f) => s + f.Premium, 0);
            const bearish = puts.filter(f => ['A','AA'].includes(f.Side)).reduce((s,f) => s + f.Premium, 0)
                + calls.filter(f => ['B','BB'].includes(f.Side)).reduce((s,f) => s + f.Premium, 0);
            const sweeps = flows.filter(f => f.Type === 'SWEEP').length;
            
            // Aggression ratio (AA/BB vs A/B)
            const aggressiveCount = flows.filter(f => ['AA','BB'].includes(f.Side)).length;
            const aggressionPct = flows.length > 0 ? Math.round((aggressiveCount / flows.length) * 100) : 0;

            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card"><div class="stat-value">${fmt(total)}</div><div class="stat-label">Total Premium</div></div>
                <div class="stat-card"><div class="stat-value bullish">${fmt(bullish)}</div><div class="stat-label">Bullish Flow</div></div>
                <div class="stat-card"><div class="stat-value bearish">${fmt(bearish)}</div><div class="stat-label">Bearish Flow</div></div>
                <div class="stat-card"><div class="stat-value">${sweeps}</div><div class="stat-label">Sweep Trades</div></div>
                <div class="stat-card"><div class="stat-value">${aggressionPct}%</div><div class="stat-label">Aggression Ratio</div></div>
                <div class="stat-card"><div class="stat-value">${flows.length}</div><div class="stat-label">Total Trades</div></div>
            `;

            // Correlated Signals (AlertStream cross-reference)
            const flowTickers = [...new Set(flows.map(f => f.Symbol))];
            const correlatedSignals = [];
            
            flowTickers.forEach(ticker => {
                const signals = [];
                const tickerFlows = flows.filter(f => f.Symbol === ticker);
                const tickerPremium = tickerFlows.reduce((s, f) => s + f.Premium, 0);
                const tickerBullish = tickerFlows.filter(f => 
                    (f.CallPut === 'CALL' && ['A','AA'].includes(f.Side)) || 
                    (f.CallPut === 'PUT' && ['B','BB'].includes(f.Side))
                ).reduce((s, f) => s + f.Premium, 0);
                const tickerBearish = tickerFlows.filter(f => 
                    (f.CallPut === 'PUT' && ['A','AA'].includes(f.Side)) || 
                    (f.CallPut === 'CALL' && ['B','BB'].includes(f.Side))
                ).reduce((s, f) => s + f.Premium, 0);
                const flowDirection = tickerBullish > tickerBearish ? 'bullish' : 'bearish';
                
                // Block trades with direction (AA/BB only - plain dark pool and neutral blocks removed as non-directional)
                if (alertStreamData.blocks[ticker]) {
                    const blocks = alertStreamData.blocks[ticker];
                    const bullishBlocks = blocks.filter(b => b.direction === 'bullish');
                    const bearishBlocks = blocks.filter(b => b.direction === 'bearish');
                    
                    if (bullishBlocks.length > 0) {
                        const match = flowDirection === 'bullish';
                        signals.push({ 
                            type: 'block_bullish', 
                            count: bullishBlocks.length,
                            notional: bullishBlocks.reduce((s, b) => s + b.notional, 0),
                            match
                        });
                    }
                    if (bearishBlocks.length > 0) {
                        const match = flowDirection === 'bearish';
                        signals.push({ 
                            type: 'block_bearish', 
                            count: bearishBlocks.length,
                            notional: bearishBlocks.reduce((s, b) => s + b.notional, 0),
                            match
                        });
                    }
                }
                
                // Insider buys
                if (alertStreamData.insider[ticker]) {
                    signals.push({ type: 'insider', count: alertStreamData.insider[ticker].length });
                }
                
                // 52-week high/low
                if (alertStreamData.weekHigh[ticker]) {
                    signals.push({ type: 'weekhigh', price: alertStreamData.weekHigh[ticker].price });
                }
                if (alertStreamData.weekLow[ticker]) {
                    signals.push({ type: 'weeklow', price: alertStreamData.weekLow[ticker].price });
                }
                
                // ORB Breakout
                if (alertStreamData.orb[ticker]) {
                    const orb = alertStreamData.orb[ticker];
                    const match = (orb.direction === 'bullish' && flowDirection === 'bullish') || 
                                  (orb.direction === 'bearish' && flowDirection === 'bearish');
                    signals.push({ type: 'orb', direction: orb.direction, match });
                }
                
                // Price Spike
                if (alertStreamData.priceSpike[ticker]) {
                    signals.push({ type: 'pricespike', percent: alertStreamData.priceSpike[ticker].percent });
                }
                
                // Halted
                if (alertStreamData.halted[ticker]) {
                    signals.push({ type: 'halted' });
                }
                
                // Volume Alert
                if (alertStreamData.volumeAlert[ticker]) {
                    signals.push({ type: 'volume' });
                }
                
                const hasEarnings = alertStreamData.earnings[ticker];
                
                if (signals.length > 0 || hasEarnings) {
                    // Calculate confirmation score
                    let confirmation = 0;
                    signals.forEach(s => {
                        if (s.type === 'block_bullish' && s.match) confirmation += 2;
                        else if (s.type === 'block_bearish' && s.match) confirmation += 2;
                        else if (s.type === 'block_bullish' && !s.match) confirmation -= 1;
                        else if (s.type === 'block_bearish' && !s.match) confirmation -= 1;
                        else if (s.type === 'orb' && s.match) confirmation += 2;
                        else if (s.type === 'orb' && !s.match) confirmation -= 1;
                        else if (s.type === 'insider' && flowDirection === 'bullish') confirmation += 1;
                        else if (s.type === 'weekhigh' && flowDirection === 'bullish') confirmation += 1;
                        else if (s.type === 'weeklow' && flowDirection === 'bearish') confirmation += 1;
                        else if (s.type === 'pricespike') confirmation += 1;
                        else if (s.type === 'volume') confirmation += 1;
                    });
                    
                    correlatedSignals.push({
                        ticker,
                        premium: tickerPremium,
                        trades: tickerFlows.length,
                        direction: flowDirection,
                        bullish: tickerBullish,
                        bearish: tickerBearish,
                        signals,
                        earnings: hasEarnings,
                        sector: alertStreamData.sector[ticker],
                        confirmation
                    });
                }
            });
            
            // Sort by confirmation score then premium
            correlatedSignals.sort((a, b) => b.confirmation - a.confirmation || b.premium - a.premium);
            
            const correlatedSection = document.getElementById('correlated-signals-section');
            const hasAlertData = Object.keys(alertStreamData.blocks).length > 0 ||
                                 Object.keys(alertStreamData.insider).length > 0 || 
                                 Object.keys(alertStreamData.earnings).length > 0 ||
                                 Object.keys(alertStreamData.weekHigh).length > 0 ||
                                 Object.keys(alertStreamData.weekLow).length > 0 ||
                                 Object.keys(alertStreamData.orb).length > 0 ||
                                 Object.keys(alertStreamData.priceSpike).length > 0 ||
                                 Object.keys(alertStreamData.halted).length > 0 ||
                                 Object.keys(alertStreamData.volumeAlert).length > 0;
            
            if (hasAlertData && correlatedSignals.length > 0) {
                // Filter: confirmation >= 1 (no conflicts), limit to top 10
                let displaySignals = correlatedSignals.filter(cs => cs.confirmation >= 1);
                if (highConvictionOnly) {
                    displaySignals = displaySignals.filter(cs => cs.confirmation >= 2);
                }
                // Filter to only show entries with AA/BB block signals
                if (requireBlocks) {
                    displaySignals = displaySignals.filter(cs => 
                        cs.signals.some(s => s.type === 'block_bullish' || s.type === 'block_bearish')
                    );
                }
                // Filter to unique tickers if enabled (already unique by ticker, but ensure no duplicates)
                if (uniqueTickersOnly) {
                    const seenTickers = new Set();
                    displaySignals = displaySignals.filter(cs => {
                        if (seenTickers.has(cs.ticker)) return false;
                        seenTickers.add(cs.ticker);
                        return true;
                    });
                }
                displaySignals = displaySignals.slice(0, 10);
                
                if (displaySignals.length > 0) {
                    correlatedSection.style.display = 'block';
                    document.getElementById('correlated-signals-count').textContent = displaySignals.length;
                    
                    const csHtml = displaySignals.map(cs => {
                    // Get average spot from this ticker's flows for live price comparison
                    const tickerFlows = flows.filter(f => f.Symbol === cs.ticker);
                    const avgSpot = tickerFlows.length > 0 ? tickerFlows.reduce((s,f) => s + f.Spot, 0) / tickerFlows.length : 0;
                    const livePriceInfo = getLivePriceInfo(cs.ticker, avgSpot, cs.direction);
                    
                    const signalBadges = cs.signals.map(s => {
                        if (s.type === 'block_bullish') return `<span class="signal-badge" style="background:rgba(63,185,80,0.15);color:var(--accent-bullish)">â–² Block AA Ã—${s.count} ${fmt(s.notional)}${s.match ? ' âœ“' : ''}</span>`;
                        if (s.type === 'block_bearish') return `<span class="signal-badge" style="background:rgba(248,81,73,0.15);color:var(--accent-bearish)">â–¼ Block BB Ã—${s.count} ${fmt(s.notional)}${s.match ? ' âœ“' : ''}</span>`;
                        if (s.type === 'insider') return `<span class="signal-badge insider">ðŸ‘¤ Insider Ã—${s.count}</span>`;
                        if (s.type === 'weekhigh') return `<span class="signal-badge" style="background:rgba(63,185,80,0.15);color:var(--accent-bullish)">ðŸ”º 52W High</span>`;
                        if (s.type === 'weeklow') return `<span class="signal-badge" style="background:rgba(248,81,73,0.15);color:var(--accent-bearish)">ðŸ”» 52W Low</span>`;
                        if (s.type === 'orb') return `<span class="signal-badge" style="background:${s.direction === 'bullish' ? 'rgba(63,185,80,0.15);color:var(--accent-bullish)' : 'rgba(248,81,73,0.15);color:var(--accent-bearish)'}">âš¡ ORB ${s.direction === 'bullish' ? 'â–²' : 'â–¼'}${s.match ? ' âœ“' : ''}</span>`;
                        if (s.type === 'pricespike') return `<span class="signal-badge" style="background:rgba(210,153,34,0.15);color:var(--accent-warning)">ðŸ“ˆ Spike +${s.percent.toFixed(1)}%</span>`;
                        if (s.type === 'halted') return `<span class="signal-badge" style="background:rgba(248,81,73,0.25);color:var(--accent-bearish)">â›” HALTED</span>`;
                        if (s.type === 'volume') return `<span class="signal-badge" style="background:rgba(88,166,255,0.15);color:var(--accent-info)">ðŸ“Š Vol Alert</span>`;
                        return '';
                    }).join('');
                    
                    const earningsBadge = cs.earnings ? `<span class="earnings-badge">ðŸ“… ER ${cs.earnings}</span>` : '';
                    const sectorInfo = cs.sector ? `<span style="font-size:0.7rem;color:var(--text-muted)">${cs.sector.industry || cs.sector.sector || ''}</span>` : '';
                    const confirmBadge = cs.confirmation >= 2 ? `<span style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;padding:0.15rem 0.4rem;border-radius:4px;background:rgba(63,185,80,0.2);color:var(--accent-bullish)">CONFIRMED</span>` : 
                                        cs.confirmation < 0 ? `<span style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;padding:0.15rem 0.4rem;border-radius:4px;background:rgba(248,81,73,0.2);color:var(--accent-bearish)">CONFLICT</span>` : '';
                    
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:var(--bg-secondary);border-radius:8px;margin-bottom:0.5rem;border-left:3px solid ${cs.direction === 'bullish' ? 'var(--accent-bullish)' : 'var(--accent-bearish)'}">
                        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap">
                            <span class="ticker-symbol" style="font-size:1rem">${cs.ticker}</span>
                            ${confirmBadge}
                            ${signalBadges}
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:4px;background:var(--bg-card)">
                                <span style="color:var(--accent-bullish)">â–²${fmt(cs.bullish)}</span>
                                <span style="color:var(--text-muted);margin:0 0.25rem">/</span>
                                <span style="color:var(--accent-bearish)">â–¼${fmt(cs.bearish)}</span>
                            </span>
                            ${livePriceInfo.badge}
                            ${earningsBadge}
                            ${sectorInfo}
                        </div>
                        <div style="display:flex;align-items:center;gap:1.5rem">
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text-muted)">${cs.trades} trades</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--accent-info)">${fmt(cs.premium)}</span>
                        </div>
                    </div>`;
                }).join('');
                
                document.getElementById('correlated-signals').innerHTML = `
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">Tickers with options flow AND AlertStream signals. <span style="color:var(--accent-bullish)">CONFIRMED</span> = direction matches, <span style="color:var(--accent-bearish)">CONFLICT</span> = signals disagree.${highConvictionOnly ? ' <span style="color:var(--accent-info)">(High Conviction: confirmation â‰¥ 2)</span>' : ''}</p>
                    ${csHtml}
                `;
                } else {
                    correlatedSection.style.display = 'none';
                }
            } else {
                correlatedSection.style.display = 'none';
            }
            
            // Helper function to get earnings badge for a ticker
            function getEarningsBadge(ticker) {
                let badges = '';
                if (alertStreamData.earnings[ticker]) {
                    badges += `<span class="earnings-badge">ðŸ“… ${alertStreamData.earnings[ticker]}</span>`;
                }
                if (alertStreamData.weekHigh[ticker]) {
                    badges += `<span class="signal-badge" style="background:rgba(63,185,80,0.15);color:var(--accent-bullish);font-size:0.65rem">ðŸ”º 52W High</span>`;
                }
                if (alertStreamData.weekLow[ticker]) {
                    badges += `<span class="signal-badge" style="background:rgba(248,81,73,0.15);color:var(--accent-bearish);font-size:0.65rem">ðŸ”» 52W Low</span>`;
                }
                if (alertStreamData.orb[ticker]) {
                    const orb = alertStreamData.orb[ticker];
                    badges += `<span class="signal-badge" style="background:${orb.direction === 'bullish' ? 'rgba(63,185,80,0.15);color:var(--accent-bullish)' : 'rgba(248,81,73,0.15);color:var(--accent-bearish)'};font-size:0.65rem">âš¡ ORB ${orb.direction === 'bullish' ? 'â–²' : 'â–¼'}</span>`;
                }
                if (alertStreamData.priceSpike[ticker]) {
                    badges += `<span class="signal-badge" style="background:rgba(210,153,34,0.15);color:var(--accent-warning);font-size:0.65rem">ðŸ“ˆ +${alertStreamData.priceSpike[ticker].percent.toFixed(1)}%</span>`;
                }
                if (alertStreamData.halted[ticker]) {
                    badges += `<span class="signal-badge" style="background:rgba(248,81,73,0.25);color:var(--accent-bearish);font-size:0.65rem">â›” HALTED</span>`;
                }
                return badges;
            }
            
            // Get live price info for a ticker
            function getLivePriceInfo(ticker, spotAtFlow, direction = null) {
                if (!livePrices[ticker]) return { badge: '', detail: '' };
                
                const lp = livePrices[ticker];
                const current = lp.current;
                const changeFromFlow = ((current - spotAtFlow) / spotAtFlow * 100).toFixed(2);
                const isUp = current > spotAtFlow;
                const changeColor = isUp ? 'var(--accent-bullish)' : 'var(--accent-bearish)';
                const arrow = isUp ? 'â–²' : 'â–¼';
                
                // Determine if trade is "winning" based on direction
                let winIndicator = '';
                if (direction) {
                    const isWinning = (direction === 'bullish' && isUp) || (direction === 'bearish' && !isUp);
                    winIndicator = isWinning ? ' âœ“' : ' âœ—';
                }
                
                const badge = `<span style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:4px;background:rgba(88,166,255,0.15);color:var(--accent-info)">Now: $${current.toFixed(2)}</span><span style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;padding:0.2rem 0.4rem;border-radius:4px;background:${isUp ? 'rgba(63,185,80,0.15)' : 'rgba(248,81,73,0.15)'};color:${changeColor}">${arrow}${Math.abs(changeFromFlow)}%${winIndicator}</span>`;
                
                return { badge, current, changeFromFlow, isUp };
            }

            // Clustering
            const clusters = {};
            flows.forEach(f => {
                const k = `${f.Symbol}|${f.Strike}|${f.ExpirationDate}|${f.CallPut}`;
                if (!clusters[k]) clusters[k] = { symbol: f.Symbol, strike: f.Strike, exp: f.ExpirationDate, cp: f.CallPut, trades: [], vol: 0, prem: 0, latestDate: '', latestTime: '' };
                clusters[k].trades.push(f);
                clusters[k].vol += f.Volume;
                clusters[k].prem += f.Premium;
                // Track latest date/time
                const tradeDateTime = `${f.CreatedDate || ''}|${f.CreatedTime || ''}`;
                const clusterDateTime = `${clusters[k].latestDate}|${clusters[k].latestTime}`;
                if (tradeDateTime > clusterDateTime) {
                    clusters[k].latestDate = f.CreatedDate || '';
                    clusters[k].latestTime = f.CreatedTime || '';
                }
            });

            const sigClusters = Object.values(clusters)
                .filter(c => c.trades.length >= 3)
                .sort((a, b) => {
                    // Sort by date then time (newest first)
                    const aDateTime = `${a.latestDate}|${a.latestTime}`;
                    const bDateTime = `${b.latestDate}|${b.latestTime}`;
                    return bDateTime.localeCompare(aDateTime);
                })
                .slice(0, 10);

            function score(c) {
                let s = 0; const checks = [];
                const atAsk = c.trades.filter(t => ['A','AA'].includes(t.Side)).length / c.trades.length;
                if (atAsk >= 0.8) { s += 2; checks.push({n:'At Ask',p:true}); }
                else if (atAsk >= 0.5) { s += 1; checks.push({n:'At Ask',p:'partial'}); }
                else checks.push({n:'At Ask',p:false});

                const oi = c.trades.filter(t => ['YELLOW','MAGENTA'].includes(t.Color)).length / c.trades.length;
                if (oi >= 0.5) { s += 2; checks.push({n:'OI Exceeded',p:true}); }
                else if (oi > 0) { s += 1; checks.push({n:'OI Exceeded',p:'partial'}); }
                else checks.push({n:'OI Exceeded',p:false});

                const sw = c.trades.filter(t => t.Type === 'SWEEP').length;
                if (sw >= 2) { s += 1; checks.push({n:'Sweeps',p:true}); }
                else if (sw >= 1) checks.push({n:'Sweeps',p:'partial'});
                else checks.push({n:'Sweeps',p:false});

                if (c.prem >= 500000) { s += 2; checks.push({n:'$500K+',p:true}); }
                else if (c.prem >= 200000) { s += 1; checks.push({n:'$200K+',p:true}); }
                else if (c.prem >= 100000) checks.push({n:'$100K+',p:'partial'});
                else checks.push({n:'Notional',p:false});

                const avgDte = c.trades.reduce((s,t) => s + t.Dte, 0) / c.trades.length;
                if (avgDte >= 10 && avgDte <= 60) { s += 1; checks.push({n:'Good DTE',p:true}); }
                else if (avgDte >= 3 && avgDte <= 90) checks.push({n:'DTE',p:'partial'});
                else checks.push({n:'DTE',p:false});

                const avgSpot = c.trades.reduce((s,t) => s + t.Spot, 0) / c.trades.length;
                const diff = Math.abs(c.strike - avgSpot) / avgSpot;
                if (diff <= 0.05) { s += 1; checks.push({n:'ATM',p:true}); }
                else if (diff <= 0.10) checks.push({n:'Near ATM',p:'partial'});
                else checks.push({n:'OTM',p:false});

                if (c.trades.length >= 5) { s += 2; checks.push({n:'5+ Trades',p:true}); }
                else if (c.trades.length >= 3) { s += 1; checks.push({n:'3+ Trades',p:true}); }

                return { score: s, checks, max: 11 };
            }

            const scored = sigClusters.map(c => ({...c, ...score(c)})).sort((a,b) => b.score - a.score);
            let highConv = scored.filter(c => c.score >= 7);
            // Filter to unique tickers if enabled (keep highest scoring entry per ticker)
            if (uniqueTickersOnly) {
                const seenTickers = new Set();
                highConv = highConv.filter(c => {
                    if (seenTickers.has(c.symbol)) return false;
                    seenTickers.add(c.symbol);
                    return true;
                });
            }
            highConv = highConv.slice(0, 10);
            document.getElementById('high-conviction-count').textContent = highConv.length;

            const hcHtml = highConv.length ? highConv.map(c => {
                const dir = c.cp === 'CALL' ? 'bullish' : 'bearish';
                const level = c.score >= 9 ? 'high' : 'medium';
                const avgSpot = c.trades.reduce((s,t) => s + t.Spot, 0) / c.trades.length;
                const avgDte = Math.round(c.trades.reduce((s,t) => s + t.Dte, 0) / c.trades.length);
                const sw = c.trades.filter(t => t.Type === 'SWEEP').length;
                const bl = c.trades.filter(t => t.Type === 'BLOCK').length;
                const earningsBadge = getEarningsBadge(c.symbol);
                const livePriceInfo = getLivePriceInfo(c.symbol, avgSpot, dir);
                return `
                <div class="flow-card">
                    <div class="flow-card-header">
                        <div class="flow-ticker">
                            <span class="ticker-symbol">${c.symbol}</span>
                            <span class="direction-badge ${dir}">${c.cp}</span>
                            ${earningsBadge}
                            ${livePriceInfo.badge}
                        </div>
                        <div class="flow-premium">
                            <div class="premium-value">${fmt(c.prem)}</div>
                            <div class="premium-label">total premium</div>
                        </div>
                    </div>
                    <div class="flow-details">
                        <div class="detail-item"><div class="detail-label">Strike</div><div class="detail-value">$${c.strike}</div></div>
                        <div class="detail-item"><div class="detail-label">Exp</div><div class="detail-value">${c.exp}</div></div>
                        <div class="detail-item"><div class="detail-label">DTE</div><div class="detail-value">${avgDte} days</div></div>
                        <div class="detail-item"><div class="detail-label">Contracts</div><div class="detail-value">${num(c.vol)}</div></div>
                        <div class="detail-item"><div class="detail-label">Trades</div><div class="detail-value">${c.trades.length} (${sw}S/${bl}B)</div></div>
                        <div class="detail-item"><div class="detail-label">Spot</div><div class="detail-value">$${avgSpot.toFixed(2)}</div></div>
                    </div>
                    <div class="flow-checklist">
                        ${c.checks.map(ch => `<span class="check-item ${ch.p === true ? 'pass' : ch.p === 'partial' ? 'neutral' : 'fail'}">${ch.p === true ? 'âœ“' : ch.p === 'partial' ? '~' : 'âœ—'} ${ch.n}</span>`).join('')}
                    </div>
                    <div class="conviction-score ${level}">Conviction: ${level.toUpperCase()} (${c.score}/${c.max})</div>
                    <p class="flow-analysis">${c.trades.length} trades clustering at $${c.strike} ${c.cp.toLowerCase()}, totaling ${num(c.vol)} contracts.</p>
                </div>`;
            }).join('') : '<p style="color:var(--text-muted)">No high conviction flows identified (score 7+ required).</p>';
            document.getElementById('high-conviction-flows').innerHTML = hcHtml;

            // Clustering - score >= 4 default, score >= 6 for high conviction, limit 10
            let displayClusters = scored.filter(c => c.score >= 4);
            if (highConvictionOnly) {
                displayClusters = displayClusters.filter(c => c.score >= 6);
            }
            // Filter to unique tickers if enabled (keep highest scoring entry per ticker)
            if (uniqueTickersOnly) {
                const seenTickers = new Set();
                displayClusters = displayClusters.filter(c => {
                    if (seenTickers.has(c.symbol)) return false;
                    seenTickers.add(c.symbol);
                    return true;
                });
            }
            displayClusters = displayClusters.slice(0, 10);
            document.getElementById('clustering-count').textContent = displayClusters.length;
            const clHtml = displayClusters.map((c, i) => {
                const dir = c.cp === 'CALL' ? 'bullish' : 'bearish';
                const earningsBadge = getEarningsBadge(c.symbol);
                const avgSpot = c.trades.reduce((s,t) => s + t.Spot, 0) / c.trades.length;
                const livePriceInfo = getLivePriceInfo(c.symbol, avgSpot, dir);
                const rows = c.trades.sort((a,b) => {
                    // Sort by date then time (newest first)
                    // First compare dates
                    const aDate = a.CreatedDate || '';
                    const bDate = b.CreatedDate || '';
                    if (aDate !== bDate) {
                        return bDate.localeCompare(aDate);
                    }
                    // Then compare times (convert to 24h for proper sorting)
                    const parseTime = (t) => {
                        if (!t) return 0;
                        const match = t.match(/(\d+):(\d+):(\d+)\s*(AM|PM)?/i);
                        if (!match) return 0;
                        let hours = parseInt(match[1]);
                        const mins = parseInt(match[2]);
                        const secs = parseInt(match[3]);
                        const period = (match[4] || '').toUpperCase();
                        if (period === 'PM' && hours !== 12) hours += 12;
                        if (period === 'AM' && hours === 12) hours = 0;
                        return hours * 3600 + mins * 60 + secs;
                    };
                    return parseTime(b.CreatedTime) - parseTime(a.CreatedTime);
                }).map(t => {
                    const oiDot = ['YELLOW','MAGENTA'].includes(t.Color) ? `<span style="color:${t.Color==='YELLOW'?'var(--accent-warning)':'var(--accent-purple)'}">â—</span>` : '<span style="color:var(--text-muted)">â—‹</span>';
                    const sideCol = ['A','AA'].includes(t.Side) ? 'var(--accent-bullish)' : 'var(--accent-bearish)';
                    const uoa = t.Uoa === 'T' ? '<span style="color:var(--accent-purple)">âœ“</span>' : '-';
                    return `<div style="display:grid;grid-template-columns:85px 90px 70px 65px 55px 75px 70px 70px 70px 40px 45px;gap:0.25rem;padding:0.4rem 0.75rem;border-bottom:1px solid var(--border-color);font-family:'JetBrains Mono',monospace;font-size:0.75rem;align-items:center;white-space:nowrap;">
                        <span style="color:var(--text-muted)">${t.CreatedDate||'-'}</span>
                        <span style="color:var(--text-muted)">${t.CreatedTime||'-'}</span>
                        <span style="color:var(--text-secondary)">${t.Type}</span>
                        <span style="color:${sideCol}">${t.Side==='A'?'ASK':t.Side==='AA'?'ABV ASK':t.Side==='B'?'BID':t.Side}</span>
                        <span>${oiDot} ${t.Color==='YELLOW'?'YLW':t.Color==='MAGENTA'?'MAG':'WHT'}</span>
                        <span style="color:var(--text-primary)">${num(t.Volume)}</span>
                        <span style="color:var(--text-secondary)">$${t.Price.toFixed(2)}</span>
                        <span style="color:var(--accent-info)">${fmt(t.Premium)}</span>
                        <span style="color:var(--text-secondary)">$${t.Spot.toFixed(2)}</span>
                        <span style="color:var(--text-muted)">${t.Dte}d</span>
                        <span>${uoa}</span>
                    </div>`;
                }).join('');
                return `
                <div class="cluster-item">
                    <div class="cluster-header" onclick="toggleCluster(${i})">
                        <div style="display:flex;align-items:center;gap:0.75rem">
                            <svg id="chevron-${i}" style="width:14px;height:14px;stroke:var(--text-muted);transition:transform 0.2s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-muted)">${c.latestDate}</span>
                            <span class="ticker-symbol" style="font-size:1rem">${c.symbol}</span>
                            <span class="direction-badge ${dir}" style="font-size:0.65rem">${c.cp}</span>
                            ${earningsBadge}
                            ${livePriceInfo.badge}
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text-secondary)">$${c.strike} Â· ${c.exp}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:1.5rem">
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text-muted)">${c.trades.length} trades</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--accent-info)">${fmt(c.prem)}</span>
                        </div>
                    </div>
                    <div id="cluster-${i}" class="cluster-trades-wrapper" style="display:none;border-top:1px solid var(--border-color);background:var(--bg-card)">
                        <div style="min-width:880px">
                            <div style="display:grid;grid-template-columns:85px 90px 70px 65px 55px 75px 70px 70px 70px 40px 45px;gap:0.25rem;padding:0.4rem 0.75rem;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border-color);white-space:nowrap">
                                <span>Date</span><span>Time</span><span>Type</span><span>Side</span><span>OI</span><span>Volume</span><span>Price</span><span>Premium</span><span>Spot</span><span>DTE</span><span>UOA</span>
                            </div>
                            ${rows}
                        </div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('clustering-analysis').innerHTML = (highConvictionOnly ? '<p style="color:var(--accent-info);font-size:0.85rem;margin-bottom:1rem">ðŸŽ¯ High Conviction: Showing only clusters with conviction score â‰¥ 6</p>' : '') + (clHtml || '<p style="color:var(--text-muted)">No significant clustering detected.</p>');

            // Large trades - $200K+ AND AA/BB (aggressive) AND OTM AND Yellow/Magenta (opening position)
            let large = flows.filter(f => {
                // Must be $200K+
                if (f.Premium < 200000) return false;
                // Must be AA or BB (most aggressive execution)
                if (!['AA', 'BB'].includes(f.Side)) return false;
                // Must be Yellow or Magenta (OI exceeded = opening position)
                if (!['YELLOW', 'MAGENTA'].includes(f.Color)) return false;
                // Must be OTM
                const isOTM = (f.CallPut === 'CALL' && f.Strike > f.Spot) || 
                              (f.CallPut === 'PUT' && f.Strike < f.Spot);
                return isOTM;
            }).sort((a,b) => b.Premium - a.Premium);
            
            // Additional filter for high conviction: require directional AlertStream signals
            if (highConvictionOnly) {
                large = large.filter(t => {
                    return alertStreamData.blocks[t.Symbol] || 
                           alertStreamData.insider[t.Symbol] ||
                           alertStreamData.orb[t.Symbol] ||
                           alertStreamData.priceSpike[t.Symbol] ||
                           alertStreamData.weekHigh[t.Symbol] ||
                           alertStreamData.weekLow[t.Symbol];
                });
            }
            
            large = large.slice(0, 10);
            document.getElementById('large-trades-count').textContent = large.length;
            const ltHtml = large.map(t => {
                const dir = t.CallPut === 'CALL' ? (['A','AA'].includes(t.Side) ? 'bullish' : 'bearish') : (['A','AA'].includes(t.Side) ? 'bearish' : 'bullish');
                const sideLabel = t.Side === 'AA' ? 'ABV ASK' : t.Side === 'A' ? 'ASK' : t.Side === 'BB' ? 'BLW BID' : t.Side === 'B' ? 'BID' : t.Side;
                const sideColor = ['A','AA'].includes(t.Side) ? 'var(--accent-bullish)' : 'var(--accent-bearish)';
                const oiDot = ['YELLOW','MAGENTA'].includes(t.Color) ? `<span style="color:${t.Color==='YELLOW'?'var(--accent-warning)':'var(--accent-purple)'}">â—</span>` : '<span style="color:var(--text-muted)">â—‹</span>';
                const earningsBadge = getEarningsBadge(t.Symbol);
                const livePriceInfo = getLivePriceInfo(t.Symbol, t.Spot, dir);
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:var(--bg-secondary);border-radius:8px;margin-bottom:0.5rem">
                    <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap">
                        <span class="ticker-symbol" style="font-size:1rem">${t.Symbol}</span>
                        <span class="direction-badge ${dir}" style="font-size:0.65rem">${t.CallPut}</span>
                        ${earningsBadge}
                        ${livePriceInfo.badge}
                        <span style="font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text-secondary)">$${t.Strike} Â· ${t.ExpirationDate}</span>
                        <span style="font-size:0.7rem;color:var(--text-muted)">${t.Type}</span>
                        <span style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:${sideColor}">${sideLabel}</span>
                        <span style="font-size:0.8rem">${oiDot}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:1.5rem">
                        <span style="font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text-muted)">${num(t.Volume)} contracts</span>
                        <span style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--accent-info)">${fmt(t.Premium)}</span>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('large-trades').innerHTML = (highConvictionOnly ? '<p style="color:var(--accent-info);font-size:0.85rem;margin-bottom:1rem">ðŸŽ¯ High Conviction: Showing only trades with confirming AlertStream signals</p>' : '') + (ltHtml || '<p style="color:var(--text-muted)">No trades matching criteria ($200K+, AA/BB, OTM, Yellow/Magenta).</p>');

            // Flow Characteristics: Moneyness + Aggression
            const moneyness = { itm: { count: 0, prem: 0 }, atm: { count: 0, prem: 0 }, otm: { count: 0, prem: 0 } };
            const aggression = { AA: { count: 0, prem: 0 }, A: { count: 0, prem: 0 }, B: { count: 0, prem: 0 }, BB: { count: 0, prem: 0 }, other: { count: 0, prem: 0 } };
            
            flows.forEach(f => {
                // Moneyness calculation
                const diff = (f.Strike - f.Spot) / f.Spot;
                const isCall = f.CallPut === 'CALL';
                let mType;
                if (Math.abs(diff) <= 0.02) {
                    mType = 'atm'; // Within 2% = ATM
                } else if ((isCall && diff < 0) || (!isCall && diff > 0)) {
                    mType = 'itm'; // Call below spot or Put above spot = ITM
                } else {
                    mType = 'otm'; // Call above spot or Put below spot = OTM
                }
                moneyness[mType].count++;
                moneyness[mType].prem += f.Premium;
                
                // Aggression breakdown
                if (['AA', 'A', 'B', 'BB'].includes(f.Side)) {
                    aggression[f.Side].count++;
                    aggression[f.Side].prem += f.Premium;
                } else {
                    aggression.other.count++;
                    aggression.other.prem += f.Premium;
                }
            });
            
            const totalPrem = flows.reduce((s, f) => s + f.Premium, 0) || 1;
            const totalCount = flows.length || 1;
            
            const moneynessHtml = `
                <div style="margin-bottom:1.5rem">
                    <h4 style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.75rem;font-weight:500">Moneyness Breakdown</h4>
                    <div style="display:flex;flex-direction:column;gap:0.5rem">
                        <div style="display:grid;grid-template-columns:60px 1fr 100px 80px;gap:1rem;align-items:center">
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent-bullish)">ITM</span>
                            <div style="background:var(--bg-card);border-radius:4px;height:24px;overflow:hidden">
                                <div style="background:var(--accent-bullish);height:100%;width:${(moneyness.itm.prem/totalPrem)*100}%;opacity:0.7"></div>
                            </div>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent-info);text-align:right">${fmt(moneyness.itm.prem)}</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-muted);text-align:right">${moneyness.itm.count} (${Math.round(moneyness.itm.count/totalCount*100)}%)</span>
                        </div>
                        <div style="display:grid;grid-template-columns:60px 1fr 100px 80px;gap:1rem;align-items:center">
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent-warning)">ATM</span>
                            <div style="background:var(--bg-card);border-radius:4px;height:24px;overflow:hidden">
                                <div style="background:var(--accent-warning);height:100%;width:${(moneyness.atm.prem/totalPrem)*100}%;opacity:0.7"></div>
                            </div>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent-info);text-align:right">${fmt(moneyness.atm.prem)}</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-muted);text-align:right">${moneyness.atm.count} (${Math.round(moneyness.atm.count/totalCount*100)}%)</span>
                        </div>
                        <div style="display:grid;grid-template-columns:60px 1fr 100px 80px;gap:1rem;align-items:center">
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent-bearish)">OTM</span>
                            <div style="background:var(--bg-card);border-radius:4px;height:24px;overflow:hidden">
                                <div style="background:var(--accent-bearish);height:100%;width:${(moneyness.otm.prem/totalPrem)*100}%;opacity:0.7"></div>
                            </div>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--accent-info);text-align:right">${fmt(moneyness.otm.prem)}</span>
                            <span style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-muted);text-align:right">${moneyness.otm.count} (${Math.round(moneyness.otm.count/totalCount*100)}%)</span>
                        </div>
                    </div>
                    <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem">ITM/ATM flow typically indicates smarter money. Heavy OTM = lottery tickets.</p>
                </div>
            `;
            
            const aggressionHtml = `
                <div>
                    <h4 style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.75rem;font-weight:500">Aggression Breakdown</h4>
                    <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:0.75rem">
                        <div style="background:var(--bg-card);border-radius:8px;padding:0.75rem;text-align:center;border-left:3px solid var(--accent-bullish)">
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--accent-bullish);margin-bottom:0.25rem">â–² AGGRESSIVE</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);margin-bottom:0.25rem">ABV ASK (AA)</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--accent-bullish)">${Math.round(aggression.AA.count/totalCount*100)}%</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--accent-info)">${fmt(aggression.AA.prem)}</div>
                        </div>
                        <div style="background:var(--bg-card);border-radius:8px;padding:0.75rem;text-align:center;border-left:3px solid rgba(63,185,80,0.5)">
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:rgba(63,185,80,0.8);margin-bottom:0.25rem">â–² BULLISH</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);margin-bottom:0.25rem">AT ASK (A)</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--text-primary)">${Math.round(aggression.A.count/totalCount*100)}%</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--accent-info)">${fmt(aggression.A.prem)}</div>
                        </div>
                        <div style="background:var(--bg-card);border-radius:8px;padding:0.75rem;text-align:center;border-left:3px solid rgba(248,81,73,0.5)">
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:rgba(248,81,73,0.8);margin-bottom:0.25rem">â–¼ BEARISH</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);margin-bottom:0.25rem">AT BID (B)</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--text-primary)">${Math.round(aggression.B.count/totalCount*100)}%</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--accent-info)">${fmt(aggression.B.prem)}</div>
                        </div>
                        <div style="background:var(--bg-card);border-radius:8px;padding:0.75rem;text-align:center;border-left:3px solid var(--accent-bearish)">
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--accent-bearish);margin-bottom:0.25rem">â–¼ AGGRESSIVE</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);margin-bottom:0.25rem">BLW BID (BB)</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--accent-bearish)">${Math.round(aggression.BB.count/totalCount*100)}%</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--accent-info)">${fmt(aggression.BB.prem)}</div>
                        </div>
                    </div>
                    <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem">AA = most aggressive bullish (paying above ask). BB = most aggressive bearish (selling below bid).</p>
                </div>
            `;
            
            document.getElementById('flow-characteristics').innerHTML = moneynessHtml + aggressionHtml;

            // Summary with Net Sentiment - require 60%+ directional dominance, limit 10
            const summ = {};
            flows.forEach(f => {
                if (!summ[f.Symbol]) summ[f.Symbol] = { sym: f.Symbol, prem: 0, vol: 0, n: 0, bullish: 0, bearish: 0 };
                summ[f.Symbol].prem += f.Premium;
                summ[f.Symbol].vol += f.Volume;
                summ[f.Symbol].n++;
                // Determine if bullish or bearish
                const isBullish = (f.CallPut === 'CALL' && ['A','AA'].includes(f.Side)) || (f.CallPut === 'PUT' && ['B','BB'].includes(f.Side));
                const isBearish = (f.CallPut === 'PUT' && ['A','AA'].includes(f.Side)) || (f.CallPut === 'CALL' && ['B','BB'].includes(f.Side));
                if (isBullish) summ[f.Symbol].bullish += f.Premium;
                if (isBearish) summ[f.Symbol].bearish += f.Premium;
            });
            // Filter for 60%+ directional dominance
            const top = Object.values(summ)
                .filter(t => {
                    const total = t.bullish + t.bearish;
                    if (total === 0) return false;
                    const dominant = Math.max(t.bullish, t.bearish);
                    return (dominant / total) >= 0.6;
                })
                .sort((a,b) => b.prem - a.prem)
                .slice(0, 10);
            document.getElementById('summary-table').innerHTML = `
                <table class="summary-table">
                    <thead><tr><th>Ticker</th><th>Trades</th><th>Contracts</th><th>Bullish</th><th>Bearish</th><th>Net</th><th>Premium</th></tr></thead>
                    <tbody>${top.map(t => {
                        const net = t.bullish - t.bearish;
                        const netClass = net > 0 ? 'bullish' : net < 0 ? 'bearish' : '';
                        const netSign = net > 0 ? '+' : '';
                        return `<tr>
                            <td class="ticker">${t.sym}</td>
                            <td>${t.n}</td>
                            <td>${num(t.vol)}</td>
                            <td style="color:var(--accent-bullish)">${fmt(t.bullish)}</td>
                            <td style="color:var(--accent-bearish)">${fmt(t.bearish)}</td>
                            <td style="color:var(--accent-${netClass});font-weight:600">${netSign}${fmt(Math.abs(net))}</td>
                            <td class="premium">${fmt(t.prem)}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table>`;

            // Expiration Heat Map
            const expMap = {};
            flows.forEach(f => {
                if (!expMap[f.ExpirationDate]) expMap[f.ExpirationDate] = { exp: f.ExpirationDate, prem: 0, bullish: 0, bearish: 0, trades: 0 };
                expMap[f.ExpirationDate].prem += f.Premium;
                expMap[f.ExpirationDate].trades++;
                const isBullish = (f.CallPut === 'CALL' && ['A','AA'].includes(f.Side)) || (f.CallPut === 'PUT' && ['B','BB'].includes(f.Side));
                const isBearish = (f.CallPut === 'PUT' && ['A','AA'].includes(f.Side)) || (f.CallPut === 'CALL' && ['B','BB'].includes(f.Side));
                if (isBullish) expMap[f.ExpirationDate].bullish += f.Premium;
                if (isBearish) expMap[f.ExpirationDate].bearish += f.Premium;
            });
            const expList = Object.values(expMap).sort((a, b) => new Date(a.exp) - new Date(b.exp));
            const maxExpPrem = Math.max(...expList.map(e => e.prem), 1);
            
            const expHtml = expList.length ? `
                <div style="display:flex;flex-direction:column;gap:0.5rem">
                    ${expList.map(e => {
                        const pct = (e.prem / maxExpPrem) * 100;
                        const net = e.bullish - e.bearish;
                        const barColor = net > 0 ? 'var(--accent-bullish)' : net < 0 ? 'var(--accent-bearish)' : 'var(--accent-info)';
                        const today = new Date();
                        const expDate = new Date(e.exp);
                        const daysOut = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                        const label = daysOut <= 0 ? '0DTE' : daysOut <= 7 ? 'This Week' : daysOut <= 14 ? 'Next Week' : daysOut <= 45 ? 'Monthly' : 'LEAPS';
                        const labelColor = daysOut <= 2 ? 'var(--accent-bearish)' : daysOut <= 7 ? 'var(--accent-warning)' : 'var(--text-muted)';
                        return `<div style="display:grid;grid-template-columns:100px 70px 1fr 100px 80px;gap:1rem;align-items:center;font-family:'JetBrains Mono',monospace;font-size:0.8rem">
                            <span style="color:var(--text-primary)">${e.exp}</span>
                            <span style="color:${labelColor};font-size:0.7rem">${label}</span>
                            <div style="background:var(--bg-card);border-radius:4px;height:24px;overflow:hidden;position:relative">
                                <div style="background:${barColor};height:100%;width:${pct}%;opacity:0.7;transition:width 0.3s ease"></div>
                                <span style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.7rem;color:var(--text-secondary)">${e.trades} trades</span>
                            </div>
                            <span style="color:var(--accent-info);text-align:right">${fmt(e.prem)}</span>
                            <span style="color:${net > 0 ? 'var(--accent-bullish)' : 'var(--accent-bearish)'};text-align:right;font-size:0.75rem">${net > 0 ? 'â–²' : 'â–¼'} ${fmt(Math.abs(net))}</span>
                        </div>`;
                    }).join('')}
                </div>` : '<p style="color:var(--text-muted)">No expiration data available.</p>';
            document.getElementById('expiration-heatmap').innerHTML = expHtml;

            // Golden Sweeps
            const strikeCounts = {};
            flows.forEach(f => { const k = `${f.Symbol}|${f.Strike}|${f.ExpirationDate}|${f.CallPut}`; strikeCounts[k] = (strikeCounts[k]||0) + 1; });
            const golden = flows.filter(f => {
                const k = `${f.Symbol}|${f.Strike}|${f.ExpirationDate}|${f.CallPut}`;
                return f.Type === 'SWEEP' && f.Color === 'YELLOW' && f.Side === 'AA' && f.Premium >= 100000 && strikeCounts[k] <= 2;
            }).sort((a,b) => b.Premium - a.Premium);
            document.getElementById('golden-sweeps-count').textContent = golden.length;
            
            const gsRows = golden.map(t => {
                const dir = t.CallPut === 'CALL' ? 'bullish' : 'bearish';
                return `<div style="display:grid;grid-template-columns:70px 85px 70px 55px 70px 70px 70px 70px 70px 70px 40px;gap:0.25rem;padding:0.5rem 0.75rem;background:var(--bg-secondary);border-left:3px solid var(--accent-warning);border-radius:6px;margin-bottom:0.4rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;align-items:center;white-space:nowrap">
                    <span style="font-weight:600;color:var(--text-primary)">${t.Symbol}</span>
                    <span style="color:var(--text-muted)">${t.CreatedTime||'-'}</span>
                    <span class="direction-badge ${dir}" style="font-size:0.6rem;padding:0.15rem 0.35rem">${t.CallPut}</span>
                    <span style="color:var(--accent-bullish)">ABV ASK</span>
                    <span style="color:var(--text-secondary)">$${t.Strike}</span>
                    <span style="color:var(--text-secondary)">$${t.Spot.toFixed(2)}</span>
                    <span style="color:var(--text-primary)">${num(t.Volume)}</span>
                    <span style="color:var(--text-secondary)">@$${t.Price.toFixed(2)}</span>
                    <span style="color:var(--accent-warning);font-weight:600">${fmt(t.Premium)}</span>
                    <span style="color:var(--text-muted)">${t.ExpirationDate}</span>
                    <span style="color:var(--text-muted)">${t.Dte}d</span>
                </div>`;
            }).join('');
            
            const gsHtml = golden.length ? `
                <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">Yellow sweeps, above ask (AA), $100K+ premium, with only 1-2 trades at that strike</p>
                <div style="overflow-x:auto"><div style="min-width:820px">
                    <div style="display:grid;grid-template-columns:70px 85px 70px 55px 70px 70px 70px 70px 70px 70px 40px;gap:0.25rem;padding:0.4rem 0.75rem;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;white-space:nowrap">
                        <span>Symbol</span><span>Time</span><span>C/P</span><span>Side</span><span>Strike</span><span>Spot</span><span>Volume</span><span>Price</span><span>Premium</span><span>Exp</span><span>DTE</span>
                    </div>
                    ${gsRows}
                </div></div>` : '<p style="color:var(--text-muted)">No golden sweeps found (Yellow sweeps, above ask AA, $100K+ premium, 1-2 trades at strike).</p>';
            document.getElementById('golden-sweeps').innerHTML = gsHtml;

            // Unusual - $100K+ AND (AA/BB OR Yellow/Magenta), limit 10
            const unusual = flows.filter(f => {
                if (f.Uoa !== 'T') return false;
                if (f.Premium < 100000) return false;
                const isAggressive = ['AA', 'BB'].includes(f.Side);
                const isOIExceeded = ['YELLOW', 'MAGENTA'].includes(f.Color);
                return isAggressive || isOIExceeded;
            }).sort((a,b) => b.Premium - a.Premium).slice(0, 10);
            document.getElementById('unusual-count').textContent = unusual.length;
            
            const uRows = unusual.map(t => {
                const dir = t.CallPut === 'CALL' ? (['A','AA'].includes(t.Side) ? 'bullish' : 'bearish') : (['A','AA'].includes(t.Side) ? 'bearish' : 'bullish');
                const oiDot = ['YELLOW','MAGENTA'].includes(t.Color) ? `<span style="color:${t.Color==='YELLOW'?'var(--accent-warning)':'var(--accent-purple)'}">â—</span>` : '<span style="color:var(--text-muted)">â—‹</span>';
                const sideCol = ['A','AA'].includes(t.Side) ? 'var(--accent-bullish)' : 'var(--accent-bearish)';
                return `<div style="display:grid;grid-template-columns:70px 85px 55px 70px 55px 55px 70px 70px 70px 70px 70px 40px;gap:0.25rem;padding:0.5rem 0.75rem;background:var(--bg-secondary);border-radius:6px;margin-bottom:0.4rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;align-items:center;white-space:nowrap">
                    <span style="font-weight:600;color:var(--text-primary)">${t.Symbol}</span>
                    <span style="color:var(--text-muted)">${t.CreatedTime||'-'}</span>
                    <span style="color:var(--text-secondary)">${t.Type}</span>
                    <span class="direction-badge ${dir}" style="font-size:0.6rem;padding:0.15rem 0.35rem">${t.CallPut}</span>
                    <span style="color:${sideCol}">${t.Side==='A'?'ASK':t.Side==='AA'?'ABV ASK':t.Side}</span>
                    <span>${oiDot}</span>
                    <span style="color:var(--text-secondary)">$${t.Strike}</span>
                    <span style="color:var(--text-primary)">${num(t.Volume)}</span>
                    <span style="color:var(--text-secondary)">@$${t.Price.toFixed(2)}</span>
                    <span style="color:var(--accent-info)">${fmt(t.Premium)}</span>
                    <span style="color:var(--text-muted)">${t.ExpirationDate}</span>
                    <span style="color:var(--text-muted)">${t.Dte}d</span>
                </div>`;
            }).join('');
            
            const uHtml = unusual.length ? `
                <div style="overflow-x:auto"><div style="min-width:850px">
                    <div style="display:grid;grid-template-columns:70px 85px 55px 70px 55px 55px 70px 70px 70px 70px 70px 40px;gap:0.25rem;padding:0.4rem 0.75rem;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;white-space:nowrap">
                        <span>Symbol</span><span>Time</span><span>Type</span><span>C/P</span><span>Side</span><span>OI</span><span>Strike</span><span>Volume</span><span>Price</span><span>Premium</span><span>Exp</span><span>DTE</span>
                    </div>
                    ${uRows}
                </div></div>` : '<p style="color:var(--text-muted)">No unusual activity matching criteria ($100K+ AND aggressive/OI exceeded).</p>';
            document.getElementById('unusual-activity').innerHTML = uHtml;
        }

        // Fetch Live Prices from Finnhub
        async function fetchLivePrices() {
            const tickers = [...new Set(allFlows.map(f => f.Symbol))];
            if (tickers.length === 0) return;
            
            fetchPricesText.textContent = 'Fetching...';
            fetchPricesBtn.disabled = true;
            
            let fetched = 0;
            const total = tickers.length;
            
            for (const ticker of tickers) {
                try {
                    const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${FINNHUB_API_KEY}`);
                    const data = await response.json();
                    if (data && data.c && data.c > 0) {
                        livePrices[ticker] = {
                            current: data.c,
                            change: data.d,
                            changePercent: data.dp,
                            high: data.h,
                            low: data.l,
                            open: data.o,
                            prevClose: data.pc,
                            timestamp: Date.now()
                        };
                    }
                    fetched++;
                    fetchPricesText.textContent = `Fetching... ${fetched}/${total}`;
                    
                    // Rate limit: 60 calls/min = 1 per second to be safe
                    if (fetched < total) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (err) {
                    console.error(`Error fetching ${ticker}:`, err);
                }
            }
            
            const priceCount = Object.keys(livePrices).length;
            fetchPricesText.textContent = `âœ“ ${priceCount} Prices Loaded`;
            fetchPricesBtn.disabled = false;
            
            // Re-run analysis to update displays with live prices
            applyFilters();
        }
        
        fetchPricesBtn.addEventListener('click', fetchLivePrices);

        // Export
        exportBtn.addEventListener('click', function() {
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            
            // Clone sections and expand them for export
            const cloneClustering = document.getElementById('clustering-section').cloneNode(true);
            cloneClustering.classList.remove('collapsed');
            cloneClustering.querySelectorAll('.cluster-trades-wrapper').forEach(el => el.style.display = 'block');
            cloneClustering.querySelectorAll('.cluster-header svg').forEach(el => el.style.display = 'none');
            
            // Clone other sections and remove collapsed state
            const sections = ['correlated-signals-section', 'high-conviction-section', 'large-trades-section', 
                            'flow-characteristics-section', 'summary-section', 'expiration-heatmap-section',
                            'golden-sweeps-section', 'unusual-section'];
            const clonedSections = {};
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.style.display !== 'none') {
                    const clone = el.cloneNode(true);
                    clone.classList.remove('collapsed');
                    clonedSections[id] = clone.outerHTML;
                } else {
                    clonedSections[id] = '';
                }
            });

            const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Flow Report - ${currentFileName}</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#0a0e14;--bg-secondary:#111820;--bg-card:#151c26;--bg-card-hover:#1a2332;--border-color:#2a3544;--text-primary:#e6edf3;--text-secondary:#8b949e;--text-muted:#6e7681;--accent-bullish:#3fb950;--accent-bearish:#f85149;--accent-warning:#d29922;--accent-info:#58a6ff;--accent-purple:#a371f7}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;padding:2rem}
.container{max-width:1100px;margin:0 auto}
h1{font-size:1.5rem;font-weight:700;margin-bottom:0.25rem}
.subtitle{color:var(--text-secondary);font-size:0.9rem;margin-bottom:2rem}
.section{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;margin-bottom:1.5rem;overflow:hidden}
.section-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:0.75rem;font-weight:600}
.section-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.section-icon.bullish{background:rgba(63,185,80,0.15);color:var(--accent-bullish)}
.section-icon.neutral{background:rgba(88,166,255,0.15);color:var(--accent-info)}
.section-icon svg{width:18px;height:18px}
.section-title{flex:1;font-size:1rem}
.section-badge{font-family:'JetBrains Mono',monospace;font-size:0.75rem;padding:0.25rem 0.6rem;border-radius:6px;background:var(--bg-secondary);color:var(--text-secondary)}
.section-chevron{width:16px;height:16px;stroke:var(--text-muted);display:none}
.section-content{padding:1.25rem;display:block!important}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:linear-gradient(135deg,var(--bg-card),var(--bg-secondary));border:1px solid var(--border-color);border-radius:12px;padding:1.25rem;text-align:center}
.stat-value{font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:700;margin-bottom:0.25rem}
.stat-value.bullish{color:var(--accent-bullish)}
.stat-value.bearish{color:var(--accent-bearish)}
.stat-label{font-size:0.85rem;color:var(--text-muted)}
.flow-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:1.25rem;margin-bottom:1rem}
.flow-card-header{display:flex;justify-content:space-between;margin-bottom:1rem}
.flow-ticker{display:flex;align-items:center;gap:0.75rem}
.ticker-symbol{font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:700}
.direction-badge{font-family:'JetBrains Mono',monospace;font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:4px;text-transform:uppercase}
.direction-badge.bullish{background:rgba(63,185,80,0.15);color:var(--accent-bullish)}
.direction-badge.bearish{background:rgba(248,81,73,0.15);color:var(--accent-bearish)}
.premium-value{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--accent-info)}
.premium-label{font-size:0.75rem;color:var(--text-muted)}
.flow-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:0.75rem;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}
.detail-item{background:var(--bg-card);padding:0.6rem 0.8rem;border-radius:8px}
.detail-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.2rem}
.detail-value{font-family:'JetBrains Mono',monospace;font-size:0.9rem}
.flow-checklist{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem}
.check-item{font-family:'JetBrains Mono',monospace;font-size:0.7rem;padding:0.25rem 0.5rem;border-radius:4px}
.check-item.pass{background:rgba(63,185,80,0.1);color:var(--accent-bullish)}
.check-item.fail{background:rgba(248,81,73,0.1);color:var(--accent-bearish)}
.check-item.neutral{background:rgba(210,153,34,0.1);color:var(--accent-warning)}
.conviction-score{font-family:'JetBrains Mono',monospace;font-size:0.8rem;padding:0.3rem 0.6rem;border-radius:6px;display:inline-block;margin-bottom:0.5rem}
.conviction-score.high{background:rgba(63,185,80,0.15);color:var(--accent-bullish)}
.conviction-score.medium{background:rgba(210,153,34,0.15);color:var(--accent-warning)}
.flow-analysis{font-size:0.9rem;color:var(--text-secondary)}
.cluster-item{background:var(--bg-secondary);border-radius:8px;margin-bottom:0.5rem;overflow:hidden}
.cluster-header{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem}
.cluster-header svg{display:none}
.cluster-trades-wrapper{border-top:1px solid var(--border-color);background:var(--bg-card);display:block!important;overflow-x:auto}
.summary-table{width:100%;border-collapse:collapse;font-size:0.9rem}
.summary-table th{text-align:left;padding:0.75rem;border-bottom:1px solid var(--border-color);color:var(--text-muted);font-size:0.75rem;text-transform:uppercase}
.summary-table td{padding:0.75rem;border-bottom:1px solid var(--border-color)}
.summary-table tr:last-child td{border-bottom:none}
.summary-table .ticker{font-family:'JetBrains Mono',monospace;font-weight:600}
.summary-table .premium{font-family:'JetBrains Mono',monospace;color:var(--accent-info)}
.signal-badge{display:inline-block;padding:0.2rem 0.5rem;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.7rem;margin-right:0.25rem;margin-bottom:0.25rem}
.correlated-flow{background:var(--bg-secondary);border-radius:8px;padding:1rem;margin-bottom:0.75rem}
.confirmation-badge{font-family:'JetBrains Mono',monospace;font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:4px}
.earnings-badge{font-family:'JetBrains Mono',monospace;font-size:0.65rem;padding:0.15rem 0.4rem;border-radius:4px;background:rgba(210,153,34,0.15);color:var(--accent-warning)}
.generated{text-align:center;color:var(--text-muted);font-size:0.8rem;margin-top:2rem;padding-top:1rem;border-top:1px solid var(--border-color)}
</style></head><body><div class="container">
<h1>Options Flow Report</h1>
<p class="subtitle">${currentFileName} Â· ${date}</p>
${document.getElementById('stats-grid').outerHTML}
${clonedSections['correlated-signals-section']}
${clonedSections['high-conviction-section']}
${cloneClustering.outerHTML}
${clonedSections['large-trades-section']}
${clonedSections['flow-characteristics-section']}
${clonedSections['summary-section']}
${clonedSections['expiration-heatmap-section']}
${clonedSections['golden-sweeps-section']}
${clonedSections['unusual-section']}
<p class="generated">Generated by Options Flow Analyzer</p>
</div></body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow-report-${currentFileName}-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
